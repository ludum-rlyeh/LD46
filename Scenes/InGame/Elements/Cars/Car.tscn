[gd_scene load_steps=7 format=2]

[ext_resource path="res://icon.png" type="Texture" id=1]
[ext_resource path="res://Scripts/StateMachine.gd" type="Script" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

export (float) var speed;

func get_direction() -> Vector2:
	return Vector2.UP.rotated(self.transform.get_rotation())

func move_straight(delta) -> void:
	position += get_direction() * speed * delta
"

[sub_resource type="GDScript" id=2]
resource_name = "GoStraight"
script/source = "extends Node

var fsm : StateMachine

onready var car = get_node(\"../..\")

func enter(var params : Array) -> void:
	print(\"Going straight\")
	
func exit(next_state : String, var params : Array) -> void:
	fsm.change_to(next_state, params)
	
func process(delta) -> void:
	car.move_straight(delta)

func _on_CollisionArea_area_entered(area : Area2D):
	if area.get_type() == Enums.TRIGGER_TYPE.ENTER_CROSS:
		exit(\"FollowPath\", [area.get_random_path()])
"

[sub_resource type="GDScript" id=3]
resource_name = "FollowPath"
script/source = "extends Node

var fsm : StateMachine

var _path_index : int
var _path_points : Array
var _offset_position : Vector2

onready var car : Node2D = get_node(\"../..\")

func enter(var params : Array) -> void:
	print(\"Following path\")
	if params.size() != 1:
		printerr(\"Error parameters, no path input\")
	else:
		var curve : Curve2D = params[0].curve
		_path_points = curve.get_baked_points()
		_path_index = 1
		_offset_position = _path_points[0] - car.position
	
func exit(next_state : String, params : Array) -> void:
	fsm.change_to(next_state, params)
	
func process(delta) -> void:
	var target = _path_points[_path_index] - _offset_position
	var direction = (target - car.position).normalized()
	car.position = target
	_path_index += 1
	
	if _path_index >= _path_points.size():
		exit(\"GoStraight\", [])

func _on_CollisionArea_area_entered(area : Area2D):
	if area.get_type() == Enums.TRIGGER_TYPE.EXIT_CROSS:
		exit(\"GoStraight\", [])
"

[sub_resource type="RectangleShape2D" id=4]
extents = Vector2( 19.1317, 32.0484 )

[node name="Car" type="Node2D"]
script = SubResource( 1 )
speed = 10.0

[node name="Sprite" type="Sprite" parent="."]
scale = Vector2( 0.6, 1 )
texture = ExtResource( 1 )

[node name="StateMachine" type="Node" parent="."]
script = ExtResource( 2 )

[node name="GoStraight" type="Node" parent="StateMachine"]
script = SubResource( 2 )

[node name="FollowPath" type="Node" parent="StateMachine"]
script = SubResource( 3 )

[node name="CollisionArea" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="CollisionArea"]
shape = SubResource( 4 )
[connection signal="area_entered" from="CollisionArea" to="StateMachine/GoStraight" method="_on_CollisionArea_area_entered"]
[connection signal="area_entered" from="CollisionArea" to="StateMachine/FollowPath" method="_on_CollisionArea_area_entered"]
